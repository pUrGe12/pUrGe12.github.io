<!doctype html><html lang=en><head><script src="https://www.googletagmanager.com/gtag/js?id=G-EKTHKNJH0Q" async></script><script>window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-EKTHKNJH0Q');</script><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Setting up a network monitor on my server</title><meta name=description><link href=/icons/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=/icons/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/icons/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/icons/site.webmanifest rel=manifest><link color=#5bbad5 href=/icons/safari-pinned-tab.svg rel=mask-icon><link rel="shortcut icon" href=/icons/favicon.ico><meta content=#00aba9 name=msapplication-TileColor><meta content=/icons/browserconfig.xml name=msapplication-config><meta content=#ffffff name=theme-color><link href=https://purge12.github.io//styles/styles.css rel=stylesheet><script>if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.documentElement.classList.add('dark')
    localStorage.setItem("theme", "dark")
  } else {
    document.documentElement.classList.remove('dark')
    localStorage.setItem("theme", "light")
  }</script><link href=https://purge12.github.io//hl-light.css id=hl rel=stylesheet><body class="antialiased text-slate-700 dark:text-slate-300 bg-white dark:bg-stone-900"><header><div class="bg-stone-300 dark:bg-stone-700 py-1"><div class="row justify-between max-w-prose m-auto px-5"><nav class="row items-center gap-2"><img alt=avatar class=h-12 src=https://purge12.github.io//img/avatar.webp><div><a class=text-xl href=https://purge12.github.io/>home</a><span class=text-xl> > </span><a class=text-xl href=https://purge12.github.io//blog>blog</a><span class=text-xl> > </span><a class=text-xl href=https://purge12.github.io//blog/setting-up-a-network-monitor>setting-up-a-network-monitor</a></div></nav><div class="row items-center gap-3"><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
</svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
</svg>' id=theme-toggle><svg class="w-6 h-6" viewbox="0 0 24 24" fill=none stroke=currentColor stroke-width=1.5 xmlns=http://www.w3.org/2000/svg><path d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" stroke-linecap=round stroke-linejoin=round /></svg></button></div></div></div></header><div class="flex justify-center items-center w-full"><main class="max-w-prose px-4 w-full"><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
</svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
</svg>' id=copy-cfg style=display:none></div><article class="col w-full" data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 19.5l-15-15m0 0v11.25m0-11.25h11.25" />
</svg>' id=post><section aria-label="Article Info" class="col pt-7 gap-4 mb-10"><h1 class=text-2xl>Setting up a network monitor on my server</h1><div class="row justify-between"><div><span class="text-lg text-stone-400" id=publish>2025-04-13</span></div><div class="flex gap-2"><a class="text-lg tl-link" href=https://purge12.github.io//tags/monitoring># Monitoring</a></div></div></section><section aria-label="Table of Contents" class="bg-stone-200 dark:bg-stone-800 p-4 rounded-lg mb-10"><h2 class="text-2xl pb-3">Contents:</h2><ul class="col gap-3"><li><a class="text-black dark:text-white text-xl underline underline-offset-8 decoration-1 hover:decoration-2 decoration-sky-500 dark:decoration-sky-400" href=#setting-up-the-proxy-in-the-client>Setting up the proxy in the client</a><li><a class="text-black dark:text-white text-xl underline underline-offset-8 decoration-1 hover:decoration-2 decoration-sky-500 dark:decoration-sky-400" href=#starting-mitmproxy-in-the-server>Starting mitmproxy in the server</a><li><a class="text-black dark:text-white text-xl underline underline-offset-8 decoration-1 hover:decoration-2 decoration-sky-500 dark:decoration-sky-400" href=#getting-certs>Getting certs</a> <ul class="col gap-2 pl-2 pt-3"><li><a class="text-lg tl-link" href=#commands-i-am-running-for-reference>Commands I am running (for reference)</a></ul></ul></section><section aria-label=Article class=tl-prose><p>The idea now is to use that flask server I created and display network logs in there as well at a certain endpoint. This is pretty cool and I will setup a <code>mitmproxy</code> to enable this. So, now all my traffic goes through the server and that is forwarded to the internet (chrome was giving issues with certs so had to use firefox).<p>Firstly to enable proxy in the client, we need to do the following<h2 id=setting-up-the-proxy-in-the-client><span class=not-prose> <a aria-label="Anchor link for: setting-up-the-proxy-in-the-client" class="tl-link text-2xl" href=#setting-up-the-proxy-in-the-client>#</a> </span> Setting up the proxy in the client</h2><ul><li>Settings > Network > VPN > Network Proxy > Manual<li>Add this line in there. (keep the port at 8080 only)</ul><pre class=z-code><code><span class="z-text z-plain">http://&LTserver_ip>
</span></code></pre><p>My server_ip is currently dynamic because I am relying on my institute’s (or ISP’s, I am not really sure) DHCP server to assign IP address. So, I’ll have to manually change this if the server’s IP changes (which will).<p>To remove the proxy just disable it, everything should go back to normal then.<h2 id=starting-mitmproxy-in-the-server><span class=not-prose> <a aria-label="Anchor link for: starting-mitmproxy-in-the-server" class="tl-link text-2xl" href=#starting-mitmproxy-in-the-server>#</a> </span> Starting mitmproxy in the server</h2><p>I’ll be using mitmproxy cause its easy as hell. Note that there are a few caveats with this. Firstly, apt install won’t work cause it causes some issues (its described in an issue in their GitHub). We install using pipx<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sudo</span></span><span class="z-meta z-function-call z-arguments z-shell"> apt-get install pipx</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">pipx</span></span><span class="z-meta z-function-call z-arguments z-shell"> ensurepath</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">pipx</span></span><span class="z-meta z-function-call z-arguments z-shell"> install mitmproxy</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">PATH</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">PATH</span></span>:/gemnasium-maven/.local/bin<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span></span>
</span></code></pre><p>This is to be run in the server. Then to start the proxy setup, we simply run<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mitmproxy</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>mode</span> regular<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>listen-host</span> 0.0.0.0<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>listen-port</span> 8080</span>
</span></code></pre><p>This will make the server a static observer of all my traffic. Then we can filter based on my client’s IP to not read anything other than that (there won’t be much, only stray devices trying to connect to my samba service and the server itself).<h2 id=getting-certs><span class=not-prose> <a aria-label="Anchor link for: getting-certs" class="tl-link text-2xl" href=#getting-certs>#</a> </span> Getting certs</h2><p>Browser’s are pretty solid these days and they can easily figure out if a hacker is trying to insert themself in the middle. So, the first thing to do after enabling proxies and starting the mitmproxy service, is to get a valid certificate.<ul><li>visit <code>http://mitm.it</code><li>Select the os/browser you’re panning to set up the proxy on<li>Follow the instructions provided and boom</ul><p>This needs to be done by the client. So, you’re actively supporting the MITM (its not an attack…) and you’re telling your browsers to do the same.<hr><p>With this basic mitmproxy setup, we can start the process of dissecting this and displaying this in the flask server.<hr><p>Alright so the first step I figured I will try is just directly piping the output of tcp dump to my flask server. Then I will add some filtering options (which will probably be difficult). So direct <code>tcpdump</code> I will simply run that as a subprocess, something like this<pre class="language-py z-code" data-lang=py><code class=language-py data-lang=py><span class="z-source z-python"><span class="z-meta z-function z-python"><span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">generate_tcpdump</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><span class="z-source z-python">    <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">process</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">subprocess</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">Popen</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">        <span class="z-meta z-sequence z-list z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python"><span class="z-punctuation z-definition z-string z-begin z-python">'</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python">sudo<span class="z-punctuation z-definition z-string z-end z-python">'</span></span></span><span class="z-punctuation z-separator z-sequence z-python">,</span> <span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python"><span class="z-punctuation z-definition z-string z-begin z-python">'</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python">/usr/bin/tcpdump<span class="z-punctuation z-definition z-string z-end z-python">'</span></span></span><span class="z-punctuation z-section z-sequence z-end z-python">]</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">        <span class="z-variable z-parameter z-python">stdout</span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">subprocess</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-variable z-other z-constant z-python">PIPE</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">        <span class="z-variable z-parameter z-python">stderr</span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">subprocess</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-variable z-other z-constant z-python">STDOUT</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">        <span class="z-variable z-parameter z-python">text</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-constant z-language z-python">True</span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">        <span class="z-variable z-parameter z-python">bufsize</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-constant z-numeric z-integer z-decimal z-python">1</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">        <span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">    <span class="z-meta z-statement z-loop z-for z-python"><span class="z-keyword z-control z-loop z-for z-python">for</span> <span class="z-meta z-generic-name z-python">line</span> <span class="z-keyword z-control z-loop z-for z-in z-python">in</span></span><span class="z-meta z-statement z-loop z-for z-python"> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">process</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">stdout</span></span></span><span class="z-meta z-statement z-loop z-for z-python"><span class="z-punctuation z-section z-block z-loop z-for z-python">:</span></span>
</span><span class="z-source z-python">        <span class="z-keyword z-control z-flow z-yield z-python">yield</span> <span class="z-storage z-type z-string z-python">f</span><span class="z-meta z-string z-interpolated z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-interpolated z-python"><span class="z-string z-quoted z-double z-python">data: </span><span class="z-meta z-interpolation z-python"><span class="z-punctuation z-section z-interpolation z-begin z-python">{</span><span class="z-source z-python z-embedded"><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">line</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">strip</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span></span></span><span class="z-meta z-interpolation z-python"><span class="z-punctuation z-section z-interpolation z-end z-python">}</span></span><span class="z-string z-quoted z-double z-python"> <span class="z-constant z-character z-escape z-python">\n</span><span class="z-constant z-character z-escape z-python">\n</span><span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-annotation z-python"><span class="z-punctuation z-definition z-annotation z-python">@</span><span class="z-meta z-annotation z-function z-python"></span></span><span class="z-meta z-annotation z-function z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">app</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-annotation z-function z-python"><span class="z-meta z-generic-name z-python">route</span></span></span></span><span class="z-meta z-annotation z-function z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span></span><span class="z-meta z-annotation z-arguments z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">/tcpdump<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-variable z-parameter z-python">methods</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-sequence z-list z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">GET<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-sequence z-end z-python">]</span></span></span><span class="z-meta z-annotation z-function z-python"><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python"><span class="z-meta z-function z-python"><span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">show_work</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><span class="z-source z-python">    <span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">Response</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">generate_tcpdump</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-variable z-parameter z-python">mimetype</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python"><span class="z-punctuation z-definition z-string z-begin z-python">'</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-single z-python">text/plain<span class="z-punctuation z-definition z-string z-end z-python">'</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></code></pre><p>This works nicely for now. The only thing to keep in mind is, to avoid giving the sudo password, we can add ourself to the sudoer list for tcpdump.<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sudo</span></span><span class="z-meta z-function-call z-arguments z-shell"> visudo</span>
</span></code></pre><p>Then inside that, add the following line:<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-redirection z-shell"><</span>username<span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> ALL=<span class="z-punctuation z-definition z-compound z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ALL</span></span><span class="z-punctuation z-definition z-compound z-end z-shell">)</span><span class="z-meta z-function-call z-arguments z-shell"> NOPASSWD: /usr/bin/tcpdump</span>
</span></code></pre><p>Make sure the path for tcpdump is correct. This will allow the server to run this tcpdump without any password.<p>I realised late that with this implementation, doing filtering and all will be pretty hard (I am not sure how I’ll do it) so we’ll see.<p>Additionally, there are some issues.<ol><li>I can’t run mitmproxy during startup because that requires a terminal interface and cronjob doesn’t support that.<li>This means if I want to get the right logs, I will have to setup the proxy and ensure that my laptop (old server) isn’t turned off.</ol><p>Ideally it should never be off, but since the IP address I am receiving from the institute is dynamic, it sucks, as I have to setup the proxy from the client to new IP addresses all the time. This is the bigger problem I will try and resolve first. Setting up my own DHCP server that talks to the institute wifi and gets a dynamic address.<p>This is how the DHCP works, straight from wikipedia docs<blockquote><p>On receiving a DHCP request, the DHCP server may respond with specific information for each client, as previously configured by an administrator, or with a specific address and any other information valid for the entire network and for the time period for which the allocation (lease) is valid. A DHCP client typically queries this information immediately after booting, and periodically thereafter before the expiration of the information. When a DHCP client refreshes an assignment, it initially requests the same parameter values, but the DHCP server may assign a new address based on the assignment policies set by administrators.</blockquote><p>In my case, the adminstrators probably assign new ip addresses every new day. Not sure of the time.<hr><p>I have a cooler idea now:<ul><li>Firstly we need static IPs cause otherwise its a pain.<li>I found an ethernet cable lying around that I want to use.<li>I can setup the ethernet connection on a different interface <code>eth0</code> and forward my internet requests through that in my new laptop<li>The server can provide a static IP to itself and the new laptop over this interface.<li>The client will then route its internet requests via the eth0 interface to the server first, who will use the dynamic IP assigned to it by the institute’s DHCP server to connect to the internet.</ul><p>I am not sure if this will work. Will test this out.<h3 id=commands-i-am-running-for-reference><span class=not-prose> <a aria-label="Anchor link for: commands-i-am-running-for-reference" class="tl-link text-2xl" href=#commands-i-am-running-for-reference>#</a> </span> Commands I am running (for reference)</h3><p>So my old laptop detects the ethernet interface but doesn’t have the drivers for it. So step 1 is installing the right driver. It uses intel’s e1000e driver so,<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">modinfo</span></span><span class="z-meta z-function-call z-arguments z-shell"> e1000e  <span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> This works</span><span class="z-comment z-line z-number-sign z-shell">
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sudo</span></span><span class="z-meta z-function-call z-arguments z-shell"> modprobe e1000e</span>
</span></code></pre><p>I checked that the drivers exist and are not bound because of something called the <code>ULP</code> mode. From the docs what I could understand is:<ul><li>This mode is a part of the Energy Efficient Ethernet (IEEE 802.3az) and not an intel thing.<li>When ULP is enabled, the Ethernet controller may enter a low-power state that makes it less responsive.</ul><p>The thing is the old server was previously my dad’s business laptop and ULP is enabled in the UEFI by default (It supports legacy as well but who cares about that).<p>This is so fucked. So apparently my e1000e doesn’t discover the NIC hardware (its not listed in the modinfo). I tried install a newer version of the e1000e driver and BAM! API misconfigs, deprecated functins etc. This is so frustrating. Without this I can’t even setup a simple LAN connection.<p>For some reason manually binding the driver raises the issuse that “the file/directory cannot be found”. BRUH I AM SITTING RIGHT HERE. its infront of me. Annoying as hell.<hr><p>https://unix.stackexchange.com/questions/625912/e1000e-error-with-b460-motherboard-and-intel-i219-v-chipset<p>Ahh, mostly likely my driver is bad as well. It is somehow “stuck” in ULP and it contantly tries to achieve that. The mailing list mentioned has code to continue execution even if ULP failed, but I am not if following that is right.<p>With this I also figured that since the old laptop was my dad’s <code>business</code> laptop, they have not even given the name of the mother board used in that. From what I could find online its a fully custom board built specifically for this laptop. This is the worst news ever because:<ol><li>My entire day of solving this hardware issue through software and kernel debugging was waste<li>I can’t even replace the motherboard</ol><p>I might try the patches mentioned in the mailing list tomorrow and see if those work. I have some time to kill before 20th cause then I am locking in and studying. So why not. Let’s see if I can get something working.<hr><p>So, I have the e1000e driver version 3.8.7 loaded and ready. Running <code>make</code> is a pain because I think there is a kernel version mismatch, as this driver proably expects an older kernel (this is downloaded straight from the intel website). I think this to be the case because my new laptop has the e1000e driver working correct without any ULP errors, has the same kernel version <code>6.8.0-57-generic</code> and consequently the builds fail in that as well. I guess intel patched the driver for future versions of the kernel but hasn’t included that on their website. So I have three choices:<ol><li>Switch to an older kernel permanantly (Easy but not a good idea as its not maintained and is probably buggy)<li>Patch the driver myself<li>Download the linux source code (that will come with the patched driver) and apply the bypass for ULP.</ol><p>I will first test out option 2 cause that seems fun.<hr><p>Alright, after a day of trying to fix the <code>netdev.c</code> and <code>ethtool.c</code> I ran into some struct definition errors in <code>ptp.c</code>, and at this point I realised I am basically wasting my time because there are a lot of dependencies that I will need to take care of now. This is too painful so I am switching to option 3 now.<p>Alright so I got kernel v6.8 cloned and tried making it. Note that running <code>make</code> won’t work because the Makefile expects to be included in the kernel build system, and is not a standalone thing. So, I had to run<p><code>make -C /lib/modules/$(uname -r)/build M=$(pwd) modules</code><p>The good thing is the build passed. sigh… If only I did this yesterday :(.<hr><p>Sad stuff happened, cause turns out the patch I wanted to do is already there. haha. :(((. What the fuck.<hr><p>Alright so if the NIC is cooked, I might be able to use an usb-to-ethernet adapter and get an interface over that.<p>I will continue this in the next blog.</section></article><hr class="h-px my-10 bg-slate-700 dark:bg-slate-300"><section aria-label="Subscription call-to-action"><div class="col gap-8"><p class="[&>a]:underline [&>a]:underline-offset-4 [&>a]:decoration-2 [&>a]:decoration-sky-500 [&>a]:dark:decoration-sky-400">Did you like this blogpost? Then consider catching up via LinkedIn or Github!<div class="flex gap-5"><form class="col gap-2 w-1/2" onsubmit="window.open('https://buttondown.com/achintya', 'popupwindow')" action=https://buttondown.com/api/emails/embed-subscribe/achintya method=post target=popupwindow><input aria-label="Email input field" class="p-2 bg-stone-300 dark:bg-stone-700n placeholder:text-slate-700 dark:placeholder:text-slate-900" placeholder="Enter your email address" id=bd-email name=email type=email><input class="rounded-md text-black dark:bg-sky-600 p-2 bg-sky-500" type=submit value=Subscribe></form><div class="flex justify-center items-center w-1/2"></div></div></div></section><div class="flex justify-center my-16"><button aria-label="back to top" id=back-to-top><svg class="w-6 h-6" viewbox="0 0 24 24" fill=none stroke=currentColor stroke-width=1.5 xmlns=http://www.w3.org/2000/svg><path d="M12 19.5v-15m0 0l-6.75 6.75M12 4.5l6.75 6.75" stroke-linecap=round stroke-linejoin=round /></svg></button></div><footer class="text-stone-400 dark:text-stone-400 row my-16 text-center"><div class=basis-full><p>© 2024-2025 Achintya Jai</div><div class=basis-full><div>Powered by <a class="text-stone-500 dark:text-stone-300 underline underline-offset-4 decoration-1 hover:decoration-2 decoration-sky-500 dark:decoration-sky-400" rel="noreferrer noopener" href=https://www.getzola.org target=_blank>zola</a> and <a class="text-stone-500 dark:text-stone-300 underline underline-offset-4 decoration-1 hover:decoration-2 decoration-sky-500 dark:decoration-sky-400" rel="noreferrer noopener" href=https://github.com/TeaDrinkingProgrammer/tranquil target=_blank>tranquil</a></div></div><div class=basis-full><a class="text-stone-500 dark:text-stone-300 underline underline-offset-4 decoration-1 hover:decoration-2 decoration-sky-500 dark:decoration-sky-400" rel="noreferrer noopener" href=https://purge12.github.io//privacy target=_blank>Privacy Policy</a></div></footer></main></div><script src=https://purge12.github.io//js/post.js></script><script src=https://purge12.github.io//js/lightense.min.js></script><script src=https://purge12.github.io//js/main.js></script>